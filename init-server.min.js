var fs=require("fs"),preappend=require("./stream-appender/stream-appender.js").preappend;
module.exports=function(){function B(a){return new Promise(function(b,d){fs.stat(e+h+"/components/"+a,function(c,f){if(c||!f.isDirectory())return d(c);b(e+h+"/components/"+a)})})}function u(a){return new Promise(function(b,d){fs.readFile(a,{encoding:"utf8"},function(a,f){if(a)return d(a);b(f)})})}function C(a){return Promise.all([u(e+h+"/components/"+a+"/"+a+".html"),u(e+h+"/components/"+a+"/"+a+".css")])}function D(a,b,d){return new Promise(function(c,f){l({component:a,query:b,headers:d},c,f)})}
function v(a,b,d){return fs.createReadStream(e+h+"/components/"+a+"/"+("dev"===b?a+".js":b+"/"+a+(d?"":".min")+".js"))}function E(){return new Promise(function(a,b){try{var d=require(process.cwd().replace(/\\/g,"/")+"/node_modules/kaleo/config.js");var c=require(e+h+"/config.js");l=require(e+h+"/auth-server.js")}catch(f){return b(f)}Object.keys(d).forEach(function(a){g[a]=d[a]});Object.keys(c).forEach(function(a){g[a]&&"object"===typeof g[a]?g[a].length?g[a].concat(c[a]):Object.keys(c[a]).forEach(function(b){g[a][b]=
c[a][b]}):g[a]=c[a]});!w&&g.prefix&&(h=g.prefix);!x&&g.base&&(e=g.base);g.environments&&(p=p.concat(g.environments));g.uriDecoder&&(q=g.uriDecoder);r=!0;a(r)})}function F(a,b){if(!b)return a;var d;b.split("\x26").forEach(function(b){d=b.split("\x3d");a[d[0]]=d[1]});return a}function G(a){var b={},d=a.query||{};b.href=(q?q:decodeURIComponent)(a.url);a=b.href;var c=a.indexOf("?"),f=a.indexOf("#");a=-1!==c?f>c?a.substring(c,f):a.substring(c,a.length):"";b.search=a;a=b.href.replace(b.search,"");c=a.indexOf("#");
a=-1!==c?a.substring(c,a.length):"";b.hash=a;b.path=b.href.replace(b.search,"").replace(b.hash,"");a=b.path;c=a.lastIndexOf(".");a=-1!==c?a.substring(c,a.length):"";b.ext=a;c=b.path;a=c.lastIndexOf(".");c=c.split("/");b.last=c[c.length-(-1!==a?2:1)];c=b.path;a=c.lastIndexOf(".");c=c.split("/");-1!==a&&(c=c.slice(0,c.length-1));a=c.join("/");b.pathname=a;b.query=F(d,b.search);b.base=b.path.replace(h,"").replace(e,"");return b}function y(a,b,d,c){B(a).then(function(){"dev"===b.env?C(a).then(function(c){z(a,
v(a,b.env,b.debug),{html:c[0],css:c[1]}).pipe(d)}).catch(function(b){console.error("ERR! Component",a,"is missing",b,"required to operate");d.end("Component missing files")}):z(a,v(a,b.env,b.debug)).pipe(d)}).catch(function(){return c()})}function z(a,b,d){return d?b.pipe(preappend('__KaleoExtensions__.components["'+a+'"] \x3d (function(){\r\n',"\r\n"+a+'.prototype.__extensionsHTML__ \x3d "'+d.html.replace(/[\r\n]/g,"").replace(/["]/g,"'")+'";\r\n'+a+'.prototype.__extensionsCSS__ \x3d "'+d.css.replace(/[\r\n]/g,
"").replace(/["]/g,"'")+'";\r\nreturn '+a+";\r\n}());")):b.pipe(preappend("__KaleoExtensions__.components["+a+"] \x3d (function(){\r\n","\r\nreturn "+a+";\r\n}());"))}function A(a,b,d){var c=G(a);if("/"===c.base||1<c.base.split(/[\/\.]/g).filter(Boolean).length)return d();var f=c.query,e=c.last;c=f.env||g.env||"dev";f.env=c;if(-1!==p.indexOf(c))"function"===typeof l?D(e,f,a.headers).then(function(){y(e,f,b,d)}).catch(function(){n(e,f);d()}):y(e,f,b,d);else return d()}function m(a){return{value:a,
writable:!1,enumerable:!1,configurable:!1}}function k(a,b,d){if(r){if(t)return d();A(a,b,d)}else E().then(function(){if(t)return d();A(a,b,d)}).catch(function(a){console.error("ERR!","Config.js is missing from",e+h,a);return d()})}var h="",e=process.cwd().replace(/\\/g,"/"),p=["dev","prod"],q,g={},l,t=!1,r=!1,w=!1,x=!1,n=function(){};Object.defineProperties(k,{prefix:m(function(a){if(!a)return h;"string"===typeof a&&(w=!!(h=a));return k}),base:m(function(a){if(!a)return e;"string"===typeof a&&(x=
!!(e=a));return k}),isDisabled:m(function(a){t=!!a;return k}),config:m(function(){return g}),auth:m(function(a){if(!a)return l;l="function"===typeof a?a:l;return k}),setAuthFailListener:m(function(a){if(!a)return n;n="function"===typeof a?a:n;return k})});return k}();